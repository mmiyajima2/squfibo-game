
# バグ

## [x] 盤面満杯のときCPUのターンだとエラーなので解消が必要
- 以下のエラーがコンソールログにでる
```txt
GameContainer.tsx:226 CPU turn planning failed: Error: No empty positions available
    at CPUEasyStrategy.decidePlacement (CPUEasyStrategy.ts:140:13)
    at CPUEasyStrategy.planTurn (CPUEasyStrategy.ts:37:37)
    at GameContainer.tsx:218:31
(anonymous) @ GameContainer.tsx:226

```
- **【完了】修正内容：**
  - `CPUEasyStrategy.ts`の`planTurn()`メソッドを修正
  - 問題：盤面満杯時に除去を「計画」しても実際には除去されていないため、`decidePlacement()`で空きがなくエラーが発生
  - 修正：`decidePlacement()`と`getEmptyPositions()`に除去予定の位置を引数として渡し、その位置を空きとして扱うように変更
  - `planTurn()`で除去予定位置を`decidePlacement(removedPosition)`に渡す
  - `getEmptyPositions()`で除去予定位置を空きとして扱う
  - 全109テスト成功

## [x] ターンの切り替えがおかしい場合がある(再2)
- 人間（下側）が、先攻
- 人間が手札をおく
- 人間がターン終了する
- CPUがカードをおく
- CPUがタターを終了する
- 人間が手札をおく
- 人間がターン終了する
- ターンがCPUにならない(なるべき)
- **【完了】修正内容：**
  - `GameContainer.tsx`の183-188行目のCPUステップキュー監視useEffectを修正
  - 問題：`cpuStepsQueue.length > 0`の条件により、キューが空になった時に`executeNextCPUStep()`が呼ばれず、`isCPUExecuting`が`false`にリセットされない
  - 修正：条件から`cpuStepsQueue.length > 0`を削除し、`isCPUExecuting`が`true`の時は必ず`executeNextCPUStep()`を呼ぶように変更
  - これにより、CPUターン終了時に確実に`isCPUExecuting`が`false`にリセットされ、次のCPUターンが正しく開始される
  - 全109テスト成功

## [x] ターンの切り替えがおかしい場合がある(再)
- 人間（下側）が、先攻
- 人間が手札をおく
- 人間がターン終了する
- CPUがカードをおく
- CPUがタターを終了する
- 人間が手札をおく
- 人間がターン終了する
- ターンがCPUにならない(なるべき)
- **【完了】修正内容：**
  - `GameContainer.tsx`のCPU自動実行useEffectの`isCPU`判定を修正
  - 従来：`currentPlayerIndex === 1`（state値）で判定
  - 修正後：`game.getCurrentPlayer().isCPU()`（実際のゲーム状態）で判定
  - これにより、`game`オブジェクトと`state.currentPlayerIndexSnapshot`が一時的に不整合を起こした場合でも、実際のゲーム状態に基づいてCPUターンが正しく実行される
  - 全109テスト成功

## [x] 画面表示で、手札がすでにあって配置できるのはおかしい
- ゲーム開始ボタンから、モーダルを経た場合のみゲームが開始されるべき
- それまでは手札もなく、そのエリアも非活性がよいかもしれない
- **【完了】修正内容：**
  - `useGameState.ts`に`hasGameStarted`フラグを追加（初期値false）
  - `RESET_GAME`アクション実行時に`hasGameStarted`をtrueに設定
  - `GameContainer.tsx`でゲーム未開始時の動作を制御：
    - HandAreaに空配列を渡し、手札を非表示に
    - HandArea、BoardGrid、ControlPanelに`disabled`プロパティを追加
    - ゲーム未開始時は全ての操作を無効化
  - CSS（HandArea.css、BoardGrid.css）に非活性状態のスタイルを追加
  - 初回アクセス時に「新しいゲームボタンを押してください」というメッセージを表示
  - 既存のビルドエラー（CommentaryType、未使用変数）も修正
  - 全109テスト成功

## [x] ターンの切り替えがおかしい場合がある
- 人間（下側）が、先攻
- 人間が手札をおく
- 人間がターン終了する
- CPUがカードをおく
- CPUがタターを終了する
- 人間が手札をおく
- 人間がターン終了する
- ターンがCPUにならない(なるべき)
- **【完了】修正内容：**
  - `useGameState.ts`の`GameStateHook`インターフェースに`version: number`フィールドを追加
  - `useGameState`の戻り値に`version: state.version`を追加し、状態変更を追跡
  - `GameContainer.tsx`のCPU自動実行useEffectの依存配列に`version`を追加
  - これにより、ゲーム状態が更新されるたびに`version`が変わり、useEffectが確実に再実行される
  - ターン切り替え時にReactが状態変更を確実に検知し、CPUターンが正しく実行されるようになった
  - 全108テスト成功（1つの確率的テストが偶発的に失敗したが、本修正とは無関係）


## [x] CPU(Easy)で、CPUが行動がおかしい
- 人間（下側）が、先攻
- 人間が手札をおく
- 人間がターン終了する
- CPUがカードをおく
- すると、人間がおいたカードがなくなってしまう.\
  なくなってはいけない
- **【完了】修正内容：**
  - `Game.ts`に`lastPlacedPosition`フィールドを追加し、最後に配置されたカードの位置を追跡
  - `CPUEasyStrategy.ts`の`selectRandomOccupiedPosition()`メソッドを修正し、直前のターンで配置されたカードを除去対象から除外
  - 盤面満杯時にCPUがカードを除去する際、人間が置いたばかりのカードを保護
  - 新しいテストケースを追加し、この動作を検証
  - 全109テスト成功

## [x] CPU(Easy)で、CPUが行動しない場合あり
- 人間（下側）が、先攻
- 人間が手札をおく
- 人間がターン終了する
- CPUが行動しないが、するべき
- **【完了】修正内容：**
  - `GameContainer.tsx`のCPU自動実行`useEffect`の依存配列に`currentPlayer.id`を追加
  - ターン切り替え時に確実にuseEffectが再実行されるように修正
  - 105行目の重複した`currentPlayer`定義を削除し、48行目の定義を使用
  - 全108テスト成功
 
#　通常タスク

## [x] CPU（Easy）を実装してほしい、コントローラレイヤーの箇所
- 一人二役の自主稽古モードは提供しないので、その分岐の考慮は不要である
- すでに実装済みのドメインレイヤーの実装をつかうこと
- ドメインレイヤーのロジックを、コントローラレイヤーにあげるべきなら、それはドメインロジックを修正すること
- **【完了】実装内容：**
  - `useGameState.ts`に`EXECUTE_CPU_TURN`アクションを追加
    - React Strict Mode対応の二重実行対策を実装
    - `executeCPUTurn()`メソッドをパブリックインターフェースに追加
  - `GameContainer.tsx`にCPUターン自動実行ロジックを追加
    - `useEffect`でCPUプレイヤーを監視し、500ms遅延で自動実行
    - CPUの行動を実況メッセージに追加
  - `CPUEasyStrategy.ts`のバグ修正
    - 役を申告しない場合に`game.endTurn()`が呼ばれていなかった問題を修正
  - 全108テスト成功・動作確認完了

## [x] CPU（Easy）を実装してほしい、まずはドメインレイヤーから
- ./docs/cpu_easy_spec.mdが行動仕様書である
- Easyからではあるが、その他の難易度の拡張性は考慮すること
- 一人二役の自主稽古モードは提供しないので、その分岐の考慮は不要である
- コントローラーレイヤは後回しとする
- **【完了】実装内容：**
  - `src/domain/services/cpu/`配下にCPU戦略を実装
    - `CPUStrategy.ts`: 戦略インターフェース（Normal, Hard拡張に対応）
    - `CPUEasyStrategy.ts`: Easy難易度の実装
      - ランダムなカード配置（盤面満杯時はランダム除去）
      - 役の優先順位選択（THREE_CARDS > TWO_CARDS_4_9 > TWO_CARDS_1_4 > CLEARING_YAKU）
      - 20%の確率で役を見落とす機構
    - `CPUStrategyFactory.ts`: 難易度に応じた戦略を生成
  - `Game.executeCPUTurn()`メソッドを追加（CPUターン自動実行）
  - ユニットテスト作成・全108テスト成功
    - 見落とし率約20%の検証
    - 優先順位選択の検証
    - ランダム配置の検証

## [x] 新しいゲームをおしたら、CPUのモードが選べるようになってほしい
- Easy, Normal, Hardの３タイプを用意してほしい
- 現在は、Easyだけを活性としあとは非活性としてほしい
- まずは、Easyから実装するので

## [x] CPU（Easy)の仕様書のマークダウンをつくってほしい
- docs/ 以下につくってほしい
- CPU(Easy) がわかるファイル名にしてほしい
- ファイル名は英語表現、内容は日本語でつくってほしい
- 5回に1度は、成立した役を見落として申告せずターン終了する振る舞いにしてほしい
- その他は、仕様書をよみといて適切にかいてほしい

# 仕様変更対応

## [x] 調整役を追加したのでその対応をしてほしい
- 調整役の解決・効果を実装すること
- 役の定義の見せ方に追加すること
- まずは実装計画をだしてほしい

# 改善

## [x] CPUの手番のペースが早すぎる
- すこしだけ時間をおいて、手札をおく、役を解決する、というふうにしてほしい
- **【完了】実装内容：**
  - ドメイン層：`planTurn()`メソッドでCPUの意思決定と実行を分離
  - コントローラー層：`executeCPUStep`アクションでステップごとの実行を実装
  - UI層：各アクションに適切な遅延を追加（500ms初期、1000ms除去、1200ms配置、1500ms役申告）
  - 各ステップで実況メッセージを表示し、ユーザーがCPUの行動を追えるように改善
  - 1ターン約3-4秒のペースで実行

## [x] 役にしようとするカードの選選がまだわかりづらい
- まずはアイデアがほしい
- 候補1: 現在の効果の線を緑にする
- 候補2: カード自体の背景色をかえる（必要なら画像を用意する）
- その他: ...
- 実装はいきなりせず、この見出しに意見を記載してほしい

### 現在の実装分析
- 現在、カード選択時は青いグロー・枠線・チェックマークで表示
- セルも青いグローでハイライト表示
- 「選択」と「役形成」が同じ青色で区別しにくい可能性

### 改善案の検討

**候補A: 役形成カードを緑系の色で区別（おすすめ）**
- 理由：
  - 通常選択（青）と役形成（緑）で明確に色分け可能
  - 実装が比較的シンプル（CSSの追加のみ）
  - 色覚特性にも配慮しやすい（青→緑の変化）
- 実装方法：
  - `isInCombo`のようなpropsを追加
  - `.card-in-combo`クラスで緑系のグロー・枠線に変更
  - セルも`.cell-in-combo`で緑系に変更

**候補B: 役の種類に応じた色分け**
- 理由：
  - 役の価値が視覚的にわかりやすい
  - THREE_CARDS（金色）> TWO_CARDS系（緑/青緑）> CLEARING_YAKU（紫）
- デメリット：
  - 実装が複雑（役の種類情報をpropsで渡す必要）
  - 色が多すぎて逆に混乱する可能性

**候補C: カード間を線で結ぶ**
- 理由：
  - 役の関係性が最も明確
  - 2枚役・3枚役がわかりやすい
- デメリット：
  - SVG/Canvas実装が必要で実装コストが高い
  - 3x3の小さい盤面では線が重なって見づらい可能性

**候補D: カードの上に小さいアイコン/ラベル表示**
- 理由：
  - 「役」であることが明示的
  - 役の種類も表示可能（「三枚」「二枚」など）
- デメリット：
  - 小さいカードでは文字が読みにくい
  - UIが少し煩雑になる

**候補E: カードに半透明の色オーバーレイ**
- 理由：
  - カード全体が色づき目立つ
- デメリット：
  - カードの数字・色の視認性が下がる
  - 画像加工が必要な可能性

**推奨：候補A（緑色での区別）を第一案として実装**
- シンプルで効果的
- 実装コストが低い
- 将来的に候補Dの小さいラベルを追加することも可能

### 【完了】実装内容
- **選択されたカードが役を形成している場合、緑色で表示するように実装**
- `GameContainer.tsx`に役の検証ロジックを追加
  - `selectedBoardCards`が変更されるたびに`comboDetector.checkCombo()`で役を検証
  - 役が成立している場合は`isValidCombo`フラグをtrueに設定
- `BoardGrid`、`Cell`、`CardComponent`に`isInCombo` propsを追加
  - `isInCombo`がtrueの場合、青色の代わりに緑色のスタイルを適用
- CSSで緑色のスタイルを追加
  - `.card-in-combo`: 緑のグロー（#22c55e）・枠線・浮遊アニメーション
  - `.card-combo-indicator`: 緑のチェックマーク
  - `.cell-in-combo`: 緑のグラデーション背景・グロー・パルスアニメーション
- 結果：選択中のカードが役を形成していない場合は青色、役を形成している場合は緑色で表示され、視覚的に区別可能に
- 全108テスト成功（1つのCPU確率的テストは偶発的失敗）・ビルド成功