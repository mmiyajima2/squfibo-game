# バグ対応

## [x] 手札がつきた時、デッキの上から1枚ドローがされない
- 手札０のままになる
- ドローボタンを押すか（人間が意識できる）
- あるいは、自動で手札にドローしてくるがよさそう
- まずは意見をきかせてほしい

### Claudeの意見
...

## [x] ボタン付近のメッセージ制御がおかしい
- 下側プレイヤーが、8枚うまっている状態でカードをおく
- すぐに、盤面が満杯・・のメッセージがでる
- そうではなく、相手のターンにわたっているときにこのメッセージはでるべき
- あるいは、これは自明なのでそもそもメッセージはいらないかも
- （だいぶわかりやすいUIに洗練されてきてるので）
- **修正完了**: 盤面満杯メッセージの表示条件に`placementHistory.length === 0`を追加。カード配置直後ではなく、次のプレイヤーのターンになった時（配置履歴クリア後）にメッセージを表示するように変更

## [x] 配置を示す効果の制御がおかしい
- 下側が赤１を配置
- それを選んで役を申告
- エラーになる
- ターン終了する
- ターンは上側にいくが、配置を示す効果がなくなってない
- なくなるべき
- **修正完了**: ターン切り替えを監視するuseEffect内でclearPlacementHistory()を呼び出すように変更。これにより、ターンが切り替わると必ず配置履歴がクリアされ、黄色の枠線効果が確実に消えるように修正。また、役申告時のバリデーションエラー時に盤面カード選択をクリアする処理を追加

## [x] ターンの切り替えがおかしいケースがある
- 下側は赤１を真ん中におく
- 上側が赤１の上の赤４をおく
- 上側プレイヤーが赤１と赤４を選び役を申告する
- 役が成立し、解決され効果を得る
- 下側プレイヤーののターになるので、手札を任意のマスにおく
- 下側プレイヤーがターン終了をする
- なのに、上側のターンにならない
- **修正完了**: CLAIM_COMBOアクションのReact Strict Mode対策で、早期リターン時にcurrentPlayerIndexSnapshotが更新されない問題を修正。これにより、役申告後の次のターン終了時にターンが正しく切り替わるように変更

## [x] 一つもカードを置かないのに、ターンが終了できてしまう
- 絶対にカードを1枚だけおかないと、ターンは変更できないようにすべき
- カードを1枚だけおかないかぎり、役を申告もターン終了も絶対にできない
- **修正完了**: handleEndTurn関数とhandleClaimCombo関数にplacementHistoryのチェックを追加。カードを配置していない場合、ターン終了と役申告の両方を拒否し、エラーメッセージを表示

## [x] 役の成立条件で形状が考慮されてない
- (赤1, 赤4)を、斜めに並ぶよう、角がぶつかる配置配置でおく
- 役を申告すると成立してしまう
- これは役として成立させてはいけない、この場合は横に2枚連なるか、縦に3枚連なるべき
- 3枚のロジックも同様にみなおしてほしい
- **修正完了**: ComboDetector.checkCombo関数に隣接性チェックを追加。2枚役は縦または横に隣接、3枚役は縦3つ・横3つ・L字型のいずれかの形状が必要に。斜め配置は拒否されるように変更

## [x] 盤面満杯時、カードが削除可能状態になるタイミングがおかしい
- 盤面に8枚うまっている
- そのターンのプレイヤーが空きに1枚をおく
- この時点でいずれかのカードが削除可能状態として選べてしまう
- 本来は、配置が確定して次のターンのプレイヤーになった時点で、削除可能状態をしめすべき
- **修正完了**: showDeleteIconsの条件にplacementHistory.length === 0を追加。このターンでカードを配置した直後は削除不可、ターン終了後（配置履歴クリア後）に削除可能になるように変更

## [x] 役には自分が置いたカードを含める条件が聞いてない
- 自分は青1をおく
- 自分が置いてない(赤1, 赤4)を選ぶ
- 役を申告すると、役が成立してしまう
- かならず、今自分が置いたカードを含む必要がある
- **修正完了**: handleClaimCombo関数内で、placementHistoryを使って今のターンで配置したカードが役に含まれているかをチェックするバリデーションを追加


## [x] ターンの切り替えに不具合がある
- 下側が赤１を中央におく、ターン終了する
- 上側が赤４を中央におく、ターン終了する
- 下側のターンにならない、下側のターンになるべき
- **修正完了**: React Strict Modeでの二重実行時に、gameの状態とcurrentPlayerIndexSnapshotが不整合になる問題を修正。不整合が検出された場合、snapshotをgameの現在の状態に同期させるように変更


## [x] 一回のターンで、２枚のカードがおけてしまう
- 一回のターンにおけるのは、1枚のカードのみ
- そのターンで2枚配置しようとしたら、警告主旨のメッセージが必要
- **修正完了**: placementHistoryの長さをチェックし、1枚以上配置済みの場合はエラーメッセージを表示

## [x] (赤1, 赤4)でやくを成立させたのに相手のターンにならない
- 相手のターンになるべき
- 役の成立について、そのターンで一つしか解決・効果がでない、仕様なのですぐにターンが交代したほうがUXがよい
- 選んだカードで役が成立してなければ、不正解のメッセージを出して、ターンは変更しない.\
役が見抜けないプレイヤーは「ターン終了」ボタンでターンを渡すしかない
- **修正完了**: CLAIM_COMBOアクション内で自動的にendTurn()を呼び出すように変更。役申告成功後は必ずターンが切り替わる


## [x] (赤1, 赤4)でやくを成立させたのに星が４個獲得されている
- 一人二役の稽古モードのはなし
- 星は2個で、デッキから2個ドローのはず
- 1, 4, 16の3個役についても確認してほしい
- **修正完了**: CLAIM_COMBOアクションにReact StrictMode対策を追加（位置が既に空の場合はスキップ）

## [x] ターン終了しても相手のターンにならない-2
- （これは、一人二役の自主稽古モードのはなし）
- あなたの手札（下側）から、一つボードにおく
- ターン終了ボタンを押す
- 上側のターンにならない -> なるべき
- 実況エリアも下側のターンとでる
- 上側のターンになって、上側が配置できるべき
- 下側は不活性になるべき
- **修正完了**: ターンに応じて現在のプレイヤーの手札のみ操作可能に設定（isOpponentを動的に制御）

## [x] ターン終了しても相手のターンにならない
- あなたの手札（下側）から、一つボードにおく
- ターン終了ボタンを押す
- 上側のターンにならない -> なるべき
- **修正完了**: 一人二役モードで両プレイヤーを操作可能に変更（isPlayer1Turnガードを削除、位置ベースの実況を実装）

## [x] 一人二役稽古モードで実況エリアの表示がおかしい
- ゲームを開始します！が、2つダブって表示している
- これは一つであるべき
- **修正完了**: useRefを使用してStrictModeでの二重実行を防止

# 改善要望

## [x] 配置を示す効果と役の選択効果がにていてわかりづらい
- 見た目の改善が必要
- まずは意見がほしい
- **修正完了**: 役の選択効果を大幅に強化。カードに回転(-3度)、強い青いグロー効果、連続的な浮遊アニメーション、左上に青いチェックマーク✓アイコンを追加。セル側も青色系に統一。配置効果（黄色系）との視覚的な区別が明確に

## [x] ボード右横エリアの改善をしたい
- 星の数が、あなた、CPUとなっているが、上側と下側でよい
- 上下関係も実際の手札の位置関係と対応させたほうがいい
- **修正完了**: GameStatus.tsxで表示を「上側」「下側」に変更し、上側（player2）を上、下側（player1）を下に表示するよう順序を変更

## [x] 今おいたカードを目立つようにした方がいいかも
- 今おいたカードが、そのターンが終了するまでは目立つようにしたほうがいいかも
- 子供向け、を踏まえてまずは意見がほしい
- **修正完了**: 黄色の太い枠線（outline）と配置直後の軽いスケールアップアニメーション（0.3秒）を実装。placementHistoryを使ってターン終了まで今置いたカードを強調表示

## [x] 画面のどこかに役の定義を簡単に示しておきたい
- 子供向けに
- 「連なる同色数字の和がフィボナッチ数」だがそれは小学生にはつたえない
- まずは意見がほしい
- **修正完了**: 実況エリアの下にComboRulesPanelを追加。小学生向けに具体的な数字の組み合わせと配置形状を簡潔に表示。フィボナッチという言葉は使わず、「1と4」「4と9」「1と4と16」と直接的に示す形に

## [x] 仕様書の曖昧さを解消したい
- 役の成立について、盤面上で並び合う状態であることを明記したい
- 2枚役なら、縦に2個つらなるか、横に2個つらなる
- 3枚役なら、縦に3個つらなるか、横に3個つらなるか、L字型で連なるか
- これを踏まえて、./docs/spec_ja.md の該当箇所の修正をして、曖昧さを排除してほしい
- **修正完了**: 役のセクションに「隣接」の明確な定義を追加（縦横のみ、斜め不可）。各役の配置形状について具体的な説明を追記


## [x]　このゲームに適切なfavicon.icoをつくって差し替えてほしい
- Claudeにおまかせする
- 仕様書から象徴的なもので、シンプルにはしてほしい
- **修正完了**: ゲームの象徴的要素（赤・青の正方形と星）を使ったシンプルなSVGファビコンを作成し、index.htmlを更新

## [x] それぞれの手札を整列したい
- 第一に、赤、青の順
- 第二に、数字の昇順
- **修正完了**: Hand.getCards()メソッドでカードを色（RED→BLUE）→数字（昇順）でソート

## [x] ターン終了の流れをかえたい
- 現状だと、「ターン終了」ボタンを教えて相手にターンを渡すとなる
- これはよいが、「役を申告」して成立した場合は、解決->効果ののち、相手にターンを渡してもよいとおもう
- まずは、実装まえにまず意見が欲しい

## [x] 一度カードおいて取取り消せようにしたい
- 現状は手札からボードにカードを押すと取り消せない
- 役を申告して成立が認められる\
あるいは、ターン終了ボタンをおす、までは取り消しできてよい
- 変更するまえに修正計画を示してほしい
- **修正完了**: 配置履歴をUIStateで管理し、「配置を取り消し」ボタンを実装

## [x] 実況エリアを下側手札の下側にしたい
- 「実況」の文言行はいらない
- 最新含めた２行分のログでよい
- 横に長くエリアはとってもよい
- 意図は、文言が長くなってもよいのと\
console.logのような位置の方がプレイのじゃまをしないと思うので
- まずは、意見をほしい
- **修正完了**: CommentaryAreaを下側手札の下に移動。ヘッダー（📢 実況）を削除し、最新2件のみ表示。console.log風のダークテーマ・等幅フォントの横長レイアウトに変更し、プレイの邪魔にならないデザインに

## [x] 下側手札の下にあるボタンをボードの側にしたい
- 一人二役の自主稽古モードだと現状は違和感なので
- 付随してボタンはもう小さいくしてもよいかも
- また「配置をキャンセル」ボタンもをやめて、配置したボタンに取り消しアイコンがあってもよいかも
- まだ実装せず、意見をきかせてほしい
- **修正完了**: ControlPanelコンポーネントを新規作成し、ボードの横（ComboRulesPanelの下）に配置。「役を申告」と「ターン終了」ボタンのみをコンパクトサイズで表示。配置を取り消しボタンは廃止し、配置したカードに直接↩️アイコンを表示。クリックで手札に戻す仕組みに変更。情報表示（エラーメッセージ、選択中カード情報など）はボード近くに移動し、一人二役モードでの違和感を解消
