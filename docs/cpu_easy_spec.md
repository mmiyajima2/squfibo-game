# CPU（Easy）仕様書

## 概要
CPU（Easy）は、SquFiboゲームにおける最も基本的なAI対戦相手です。
小学生のプレイヤーが楽しく対戦できるよう、適度に役を見落とす振る舞いを持ちます。

---

## 難易度コンセプト
- **対象プレイヤー**：ゲームに慣れ始めた小学生
- **強さレベル**：初級（役の見落としあり）
- **プレイスタイル**：ランダム性が高く、戦略性は低い
- **教育的価値**：プレイヤーが「CPU より多く気づけた」という成功体験を得やすい

---

## 基本的な振る舞い

### 1. カード配置の戦略
CPU（Easy）は以下の手順でカードを配置します：

#### 1.1 盤面が満杯の場合
- **処理**：盤面上のカードを1枚除去してから配置
- **選択方法**：ランダムに1枚選んで捨て札にする
- **考慮事項**：特に戦略的な判断は行わない

#### 1.2 手札がある場合
- **処理**：手札から1枚選んで空いているマスに配置
- **選択方法**：
  1. 手札からランダムに1枚選択
  2. 空いているマスからランダムに1つ選択
  3. 選んだカードを選んだマスに配置

#### 1.3 手札が0枚の場合
- **処理**：山札の一番上のカードを1枚引き、そのまま配置（ゲームルール通り）
- **選択方法**：空いているマスからランダムに1つ選択

---

### 2. 役の検出と申告の戦略

#### 2.1 役の検出
カード配置後、`ComboDetector.detectCombos(board, lastPlacedPosition)`を使用して、
今回置いたカードを含む成立可能な役を全て検出します。

検出される可能性のある役：
- **THREE_CARDS**（大役）：赤または青の1+4+16（星3個）
- **TRIPLE_MATCH**（小役）：赤または青の同じ数字3枚（星1個）

#### 2.2 役の申告判定（見落とし機構）

**重要：CPU（Easy）の特徴的な振る舞い**

役が検出された場合、以下のロジックで申告するかどうかを決定します：

```
if (検出された役がある) {
  ランダムに1～5の整数を生成

  if (生成された値が5) {
    // 20%の確率（5分の1）
    → 役を見落とす：申告せずにターン終了
  } else {
    // 80%の確率（5分の4）
    → 役を申告する
  }
}
```

**実装のポイント**：
- 乱数生成は各ターンごとに独立して行う
- 見落とし判定は役の種類に関わらず一律20%
- 見落とした場合、役は成立しなかったものとして処理される

#### 2.3 複数の役がある場合の優先順位

複数の役が検出された場合、以下の優先順位で1つだけ選択します：

1. **THREE_CARDS**（1+4+16）
   - 理由：最も多くの星（3個）を獲得できる大役のため
2. **TRIPLE_MATCH**（同じ数字3枚）
   - 理由：星1個を獲得できる小役

**注意**：見落とし判定（20%）は、この優先順位選択の**後**に行われます。

---

### 3. ゲーム終了判定への対応

CPU（Easy）は以下の終了条件を自動的に認識します：
- 場の星がすべて獲得されたとき
- 山札が0枚になったとき

終了条件に達した場合、自動的にゲーム終了となり、星の数で勝敗が決まります。

---

## 実装時の参考情報

### 使用する主要クラス・メソッド

#### 役の検出
```typescript
ComboDetector.detectCombos(board: Board, lastPlacedPosition: Position): Combo[]
```
- 最後に置いたカードを含む全ての役を返す
- 返り値の`Combo`オブジェクトには`type`、`cards`、`positions`が含まれる

#### 役の妥当性検証
```typescript
ComboDetector.checkCombo(cards: Card[], positions: Position[]): ComboType | null
```
- 選択されたカードと位置が役を構成するか検証
- 隣接性のチェックも含まれる

#### 盤面の状態確認
```typescript
Board.getCard(position: Position): Card | null
Board.isEmpty(position: Position): boolean
Board.isFull(): boolean
```

---

## テストケース例

### テストケース1：役の見落とし率の検証
- **目的**：5回に1回（20%）の見落としが発生することを確認
- **手順**：
  1. 100回のターンをシミュレート
  2. 各ターンで役が成立する状況を作る
  3. 申告された回数と見落とした回数を記録
- **期待結果**：見落とし率が約20%（許容範囲：15～25%）

### テストケース2：優先順位の検証
- **目的**：複数の役がある場合、正しい優先順位で選択されることを確認
- **手順**：
  1. 盤面にTHREE_CARDSとTRIPLE_MATCHの両方が成立する状況を作る
  2. CPUがTHREE_CARDSを選択することを確認（見落とさない場合）
- **期待結果**：優先順位に従って大役が選択される

### テストケース3：ランダムな配置の検証
- **目的**：カード配置がランダムであることを確認
- **手順**：
  1. 同じ盤面状態から100回配置をシミュレート
  2. 配置位置の分布を記録
- **期待結果**：特定の位置に偏らない（概ね均等）

---

## 実装時の注意事項

### 1. 乱数生成
- JavaScriptの`Math.random()`を使用
- 見落とし判定：`Math.floor(Math.random() * 5) + 1`で1～5の整数を生成し、5が出たら見落とし

### 2. 役の申告処理
- 見落とした場合でも、役が検出されていたことをログに記録（デバッグ用）
- ユーザーには「CPUはターンを終了しました」と表示

### 3. コメンタリー（実況）
`Commentary.ts`に定義されているメソッドを適切に呼び出す：
- `Commentary.cpuTurn()`：CPUのターン開始時
- `Commentary.cpuPlacedCard()`：カード配置後
- `Commentary.cpuClaimedCombo()`：役を申告した時
- `Commentary.cpuGotStar()`：星を獲得した時

### 4. パフォーマンス
- `detectCombos()`の呼び出しは1ターンに1回のみ
- 不要な盤面走査を避ける

---

## 今後の拡張性

CPU（Easy）の実装後、以下の難易度追加が考えられます：

### CPU（Normal）
- 役の見落とし率：10%（10回に1回）
- 盤面満杯時の除去カード選択に簡単な戦略を追加

### CPU（Hard）
- 役の見落としなし（100%申告）
- カード配置時に役が成立しやすい位置を選択
- 相手の役成立を妨害する戦略

---

## バージョン履歴
- **v1.0（2026-01-31）**：初版作成
