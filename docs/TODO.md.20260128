# タスク

## [x] 特殊ケース処理を実装してほしい（フェーズ2d）
   - 盤面満杯時のカード廃棄処理
   - 手札0枚時の山札からの直接配置
   - ゲーム終了と勝敗表示

### 実装完了
以下の特殊ケース処理を実装しました：

#### 1. 盤面満杯時のカード廃棄処理
- `Game.discardFromHand(card)`: 手札からカードを廃棄するメソッドを追加
- 盤面が満杯の時、「カード廃棄」ボタンが表示される
- 手札からカードを選択して廃棄ボタンを押すとカードを廃棄
- 廃棄したカードは捨て札に移動
- 盤面満杯時の警告メッセージを表示

#### 2. 手札0枚時の山札からの直接配置
- `Game.drawAndPlaceCard(position)`: 山札からカードを引いて直接配置するメソッドを追加
- 手札が0枚の時、空きマスをクリックすると自動的に山札から引いて配置
- 手札なしの案内メッセージを表示
- 山札が空の場合はエラーメッセージ

#### 3. ゲーム終了と勝敗表示
- ゲーム終了判定の改善:
  - 全ての星が配布された時
  - 山札が空になった時
  - **盤面が満杯で、両プレイヤーとも手札がない時**（新規追加）
- ゲーム終了時のモーダル表示:
  - 勝者の表示（「あなたの勝ち！」「CPUの勝ち！」「引き分け！」）
  - 最終スコアの表示
  - 「新しいゲーム」ボタン
  - アニメーション付きの美しいモーダルデザイン

#### テスト
- `discardFromHand()` のテストを追加
- `drawAndPlaceCard()` のテストを追加
- 盤面満杯時のゲーム終了判定のテストを追加
- 全テスト（89個）が成功

## [x] 役申告機能の改善意見がほしい（フェーズ2c-3）
   - やはり「役の自動検出」はやめたい
   - かわりに、申告するボタン、をつくる
   - 基本の流れを以下にする
     - カードを配置する
     - 役を検知した子供は申告するボタンをおす
     - そこでモーダルがでて役を指定させる
     - それがあっていれば役の解決・効果へと流れる
     - 最後はターン終了を教えて相手にターンを渡す
     - （つまり、かならずターン終了は押す）
   - ~~まずは意見だけ欲しい~~
   - 難しいモードだけで実装してほしい、モード切り替え機能はまだ不要である
   - 不正申告には「おしい！」とか配慮したメッセージがよい\
  発展させるなら、役は数字の和がフィボナッチ数になること（これは小学生が知らなくてもよい言葉）をさりげなく教えるとよいかも

### 実装完了（モーダルなしバージョン）
以下の機能を実装しました：
- 自動検出機能を削除し、完全手動申告モードに変更
- 盤面のカードをクリックして選択できる機能
- 選択されたカードは**目立つUIで表示**：
  - オレンジのグラデーション背景
  - 太い境界線（4px）
  - 光るシャドウエフェクト
  - パルスアニメーション
  - 少し拡大表示（1.05倍）
- 「役を申告」ボタンを追加（オレンジ色）
- **モーダルなし**で直接検証
- 選択されたカードから自動的に役を判定し、正しければ確定
- 配慮したエラーメッセージ：
  - 役ではない場合：「おしい！選択したカードは役ではありません」

**操作フロー:**
1. カードを配置
2. 盤面のカードをクリックして選択（光るオレンジのエフェクト）
3. 「役を申告」ボタンを押す
4. 自動検証して正しければ確定、間違いなら「おしい！」メッセージ

### ClaudeCodeの意見

#### 提案内容の評価

**要求される変更:**
- 役の自動検出を廃止
- プレイヤーが自分で役を見つけて「申告ボタン」を押す
- モーダルで役を指定させる
- 正しければ役解決、間違いならエラー
- 必ずターン終了ボタンを押してターンを渡す

**評価: 教材としては優れているが、実装とUX設計に工夫が必要**

---

#### メリット（教育的観点）

1. **学習目標に直結**
   - 「役を自分で見つける」という行為が学習の中心になる
   - 数字のパターン認識能力が向上する
   - 受動的な「確認」から能動的な「発見」へ

2. **達成感の向上**
   - 自分で見つけた役を申告する喜び
   - 正解したときの満足感が大きい

3. **思考力の育成**
   - 「どこに置けば役ができるか」を考える力
   - 見逃しリスクがあるため、注意深く観察する習慣がつく

---

#### 懸念点（UX/実装観点）

1. **初心者の挫折リスク**
   - 役を見逃してしまう可能性が高い
   - 特に低学年の子供には難易度が高すぎるかもしれない
   - 見逃したまま「ターン終了」を押してしまい、損をする

2. **UI設計の複雑化**
   - 「どのカードが役を構成しているか」をプレイヤーに選択させる必要がある
   - カードの複数選択UI（タップして選択、もう一度タップで解除）が必要
   - 誤選択への対応（選択ミス、選び直し）

3. **役の検証ロジック**
   - プレイヤーが選択したカードが実際に役を構成しているか検証
   - エラーメッセージの表示（「選択したカードは役ではありません」）
   - 不正な申告へのペナルティは必要か？（教材なので不要と思うが）

4. **ゲームのテンポ悪化**
   - 毎回盤面をじっくり確認する時間が必要
   - 「申告するかしないか」の判断に時間がかかる
   - ゲーム1回の所要時間が伸びる

---

#### 推奨する実装アプローチ

**基本方針: 学習モード切り替え機能を導入**

##### オプション1: 難易度別モード（推奨）
ゲーム開始時に難易度を選択できるようにする：

- **かんたんモード（デフォルト）**: 現在の実装（自動検出 + 5秒タイマー）
- **ふつうモード**: 自動検出するが申告は手動（ヒント機能）
- **むずかしいモード**: 自動検出なし、完全手動申告（今回の要求）

**メリット:**
- 学習段階に応じて選べる
- 初心者は「かんたん」から始めて、慣れたら「むずかしい」に挑戦
- 教材としての対象年齢の幅が広がる

##### オプション2: ヒント機能付き手動申告
役の自動検出は廃止するが、ヒント機能を用意：

1. カード配置後、「役を申告」ボタンが常時表示される
2. プレイヤーが役を見つけたと思ったら、盤面のカードを選択
3. 選択したカードで「申告」ボタンを押す
4. **ヒント機能**: 「役があるかな？」ボタンを押すと、役があるかどうかだけを教える（どれかは教えない）
5. 正しければ役解決、間違いなら「それは役ではありません」と表示

**メリット:**
- 完全手動だが、初心者向けのサポートがある
- ヒントは任意なので、使わない上級者にも対応

---

#### 具体的なUI設計案

**画面構成:**
```
[CPU の手札（伏せ）]

[ゲーム状態表示]
[3x3ボード]        [実況エリア]

[あなたの手札]
[役を申告] [ターン終了] ← 両方常時表示
```

**操作フロー:**

1. **カードを配置**
   - 手札からカードを選択 → 盤面に配置

2. **役を探す（プレイヤー）**
   - 盤面を見て、役があるか確認
   - 役を見つけたら、役を構成するカードを**タップして選択**（カードが黄色くハイライト）
   - 選択ミスしたら再度タップで選択解除

3. **役を申告**
   - 「役を申告」ボタンを押す
   - 選択したカードが役を構成しているか検証
   - **正解**: モーダルで「○○ペア！★+2」と表示 → 役解決 → カード除去・ドロー
   - **不正解**: 「選択したカードは役ではありません」エラー表示 → 選択解除してやり直し

4. **ターン終了**
   - 役を申告した後、またはスキップした後
   - 「ターン終了」ボタンを押してCPUにターンを渡す

---

#### 技術的実装の変更点

**削除する機能:**
- カード配置後の自動役検出呼び出し（`comboDetector.detectCombos`）
- 自動申告タイマー（`startAutoClaimTimer`、`autoClaimCountdown`）
- ComboPanelの自動表示

**追加する機能:**

1. **カード選択状態の管理**
   ```typescript
   const [selectedCardsForClaim, setSelectedCardsForClaim] = useState<Card[]>([]);
   ```

2. **盤面カードの選択ハンドラ**
   ```typescript
   const handleBoardCardSelect = (card: Card) => {
     // 既に選択されていればトグル解除、そうでなければ追加
   }
   ```

3. **役申告ボタンのハンドラ**
   ```typescript
   const handleManualClaimCombo = () => {
     // 選択されたカードでComboDetectorを使って役を検証
     // 正しければclaimCombo、間違いならエラー
   }
   ```

4. **モーダルの表示タイミング変更**
   - 現在: カード配置後に自動表示
   - 変更後: 「役を申告」ボタン押下後に表示（検証結果）

---

#### 最終推奨

**段階的な実装を推奨:**

**ステップ1（最小限）**: ヒント機能なしの完全手動申告
- 役の自動検出を廃止
- 「役を申告」ボタンを常時表示
- プレイヤーが盤面のカードを選択して申告
- 検証して正しければ役解決、間違いならエラー

**ステップ2（追加改善）**: ヒント機能の追加
- 「役があるかな？」ボタンを追加
- 押すと「役があります！探してみよう」または「役はないよ」と表示

**ステップ3（理想）**: 難易度選択機能
- ゲーム開始時に難易度を選択
- かんたん/ふつう/むずかしい の3段階

---

#### 質問事項

実装前に確認したい点：

1. **対象年齢**: 何歳くらいの子供を想定していますか？
   - 低学年（6-8歳）なら、ヒント機能は必須
   - 高学年（9-12歳）なら、完全手動でも問題なさそう

2. **誤申告のペナルティ**: 間違った役を申告した場合、何かペナルティは必要ですか？
   - 案A: ペナルティなし（エラー表示のみ）← 教材なので推奨
   - 案B: 星を1つ失う（厳しめ）

3. **役の見逃し**: 役があるのに見逃してターン終了した場合、どうしますか？
   - 案A: 何も起こらない（損をするだけ）
   - 案B: 「役を見逃しましたよ」と後から教える（学習重視）← 推奨

4. **難易度選択**: 最初から難易度選択機能を実装しますか？
   - それとも、まず「むずかしいモード」のみを実装して、様子を見ますか？
  

## [x] 役申告機能の改善意見がほしい（フェーズ2c-2）
   - ヒントいらないかもしれない
   - 毎回配置後に役を選ばせるがいいかもしれない
   - 子供向けの教材で画面構成もシシンプルなので毎回役解決するか、聞いてもよいかも
   - ただ、UI/UXの観点でストレスになるかもしれないのは、懸念である
   - ~~まだ、実装はしなくてよい~~
   - 案Bで実装をお願いしたい。またシンプルにしたいので、モードの分岐は不要である

### 実装完了（案B: 軽量確認モード）
- モーダルパネルを画面上部の軽量な通知バナーに変更
- 5秒のカウントダウンタイマーを実装（画面上に表示）
- タイマーが0になると自動的に最初の役を申告
- プレイヤーは手動で申告ボタンまたはスキップボタンを押すことも可能
- ゲームの流れを止めず、スムーズな体験を実現

### ClaudeCodeの主張

#### 現在の実装の評価
現在の実装は以下の流れになっています：
1. カード配置 → 2. 役の自動検出 → 3. 役があればモーダルパネル表示 → 4. 役申告 or スキップ

**優れている点：**
- 役がある時だけパネルが表示される（役がない時は邪魔にならない）
- モーダル形式で注目を集め、子供でも見逃しにくい
- スキップ機能で柔軟性を確保

**課題点：**
- ゲームの流れが一時停止する（モーダルが割り込む）
- 役を見つける楽しみがシステム側で処理される

---

#### 提案に対する分析

**1. 「ヒントいらないかもしれない」について**
- **賛成**: 子供向け教材としては、役の検出自体が学習目標のはず
- **現状の問題**: 自動検出により「役を探す」という学習機会を失う
- **提案**: ヒント機能を「学習モード」として任意でオン/オフできると良い

**2. 「毎回配置後に役を選ばせる」について**
- **反対**: これは大きなストレスになる可能性が高い
  - 役がない時も毎回パネルを見せるのは冗長
  - ゲームのリズムを大きく損なう
  - 「役なし」を選択する作業は無駄なクリック

**3. 「毎回役解決するか、聞いてもよい」について**
- **条件付き賛成**: "役がある時だけ"という前提であれば良い設計
- **現在の実装は既にこれに近い**: 役がある時だけモーダルが表示される
- **改善案**: モーダルではなく、より軽量なUIで確認できると良い

**4. 「UI/UXの観点でストレスになるかもしれない」**
- **同意**: これが最も重要な懸念
- **子供向けゲームの鉄則**: スムーズな流れと即座のフィードバック

---

#### 推奨する改善案

現在の実装を基に、以下の3パターンを提案します：

##### **案A: 自動申告モード（推奨）**
子供向け教材として最もシンプルで学習に集中できる設計。

- カード配置後、役があれば**自動的に申告・解決**
- モーダルやボタン選択は不要
- 実況エリアで「赤の1-4ペアができました！★+1」と表示
- アニメーションで役のカードをハイライト → 除去 → ドロー

**メリット:**
- 最もスムーズな流れ（中断なし）
- 子供が迷わない（選択肢がない）
- ゲームのリズムが保たれる
- プログラミング的思考に集中できる（役の組み合わせを考える）

**デメリット:**
- 役を申告しない戦略が取れない（ただしこのゲームでは役を取らないメリットは薄い）

##### **案B: 軽量確認モード（バランス型）**
モーダルではなく、ゲーム画面内に軽量な通知を表示。

- カード配置後、役があれば画面上部に通知バナー表示
  - 「赤の1-4ペアができました！ [申告する] [スキップ]」
- 5秒後に自動的に申告（またはプレイヤーがボタン押下）
- ゲームの流れを止めない

**メリット:**
- 戦略性を残せる（スキップ可能）
- モーダルより軽量で流れを邪魔しない
- デフォルトで自動申告されるので迷わない

**デメリット:**
- 5秒待つのがストレスになる可能性

##### **案C: 教材特化モード（学習重視）**
役の検出をプレイヤーに委ねる設計。

- 役の自動検出を**オフ**にする
- 「役を申告」ボタンを常時表示
- プレイヤーが自分で役を見つけて、カードを選択して申告
- 正しい役か検証し、正しければ解決、間違いならエラー表示

**メリット:**
- 「役を探す」学習機会を提供
- ゲームの流れを止めない（プレイヤーが任意のタイミングで申告）
- 認知的負荷が高く、より深い学習になる

**デメリット:**
- 初心者には難しい
- 役を見逃すリスクがある
- UIが複雑になる（カード選択インタラクションが増える）

---

#### 最終推奨

**子供向け教材**という目的を最優先するなら、**案A（自動申告モード）を強く推奨**します。

**理由:**
1. **学習目標は「役の組み合わせを理解する」こと**: 配置時に「これで役ができる」と考えることが学習であり、申告ボタンを押す行為自体に学習効果はない
2. **ストレスフリー**: 子供が迷わず、ゲームに集中できる
3. **即座のフィードバック**: 配置 → 役完成 → 報酬という流れがスムーズで、学習効果が高い
4. **実装コスト**: 現在の実装からモーダルとスキップ機能を削除するだけで実現可能

**設定で選べるようにする**のも良い案：
- デフォルト: 案A（自動申告）
- 上級者向け: 案C（手動検出・手動申告）

これにより、初学者から熟練者まで対応できるゲームになります。



## [x] 役申告機能を実装したい（フェーズ2c）
   - ComboDetectorを使った役の検出（ヒント表示用）
   - 役申告パネル
   - 申告パネルには役を見つけられないケースを考慮して、スキップ相当の表現のボタンがほしい
   - 役が成立した時の処理（カード除去、ドロー、星獲得）


## [x] 実況エリアについてUI改善したい
- 履歴の表示はいらない
- 一番上の、最新メッセージだけ大きくする必要もない
- 単に、最大３件のメッセージがでて、最新にある上のものだけ目立つのがよい

## [x] カードも正方形にしてほしい
- カードが現在長方形となっているので正方形にしたい
- ボードのマスは正方形なのでそれに合わせたい
- このゲームはSqureが大事ななので

## [x] 実況エリアのメッセージの数制限が必要（フェーズ2b-2）
- メッセージは最新含め３件でよい
- 画面がどんどん下に伸びてしまうから
- 変数としても抱えておく必要なく、すてればよい（メモリ圧迫解消）

## [x] 基本操作を実装してほしい（フェーズ2b）
   - 手札からカードを選択
   - 盤面の空きマスにカードを配置
   - ターン終了ボタン
   - 追加改善: 配置可能なセルのハイライト表示、エラーメッセージ表示


## [x] プレゼンテーション改善(step1-2)
  - 上下の画面の収まりが悪いので、全体的に縦サイズを縮めてほしい
  - カードは正方形にしてほしい、Squreはゲームのテーマだから
  - ボードの横に実況エリアを用意してほしい\
  子供達がわかりやすいようにしたい、「CPUのターンです」「CPUがカードをおきました」
  - いきなり実装せず、一般的なUI/UX設計から考えて、上記をレビューした意見がほしい

## [x] プレゼンテーション層の実装をしてほしい(step1)
   - CardComponent: カードの視覚的表示（既存の画像素材を使用）
   - BoardGrid & Cell: 盤面の表示とクリック可能なマス
   - HandArea: 手札の表示
   - GameStatus: 現在のターン、星の数、山札残り枚数
   - テーマはライトで
   - 上側にCPU側の領域、下側に人間領域がくる前提で 

## [x] UI状態管理の作成作成してほしい
- このファイルの [Claude Code レポート] の計画にならうこと
- Hookの作成でとどめること

## [x] ゲーム状態管理Hookの作成してほしい
- このファイルの [Claude Code レポート] の計画にならうこと
- Hookの作成でとどめること

## [x] ドメイン層ができたあとの手順についてアドバイスがほしい
- まだ実装はしなくてよい
- 当面の目標は、1人対局モードが実現できること
- （その次にCPU(Easy)を用意する予定）

### Claude Code レポート

#### 現在の状態（完成済み）
ドメイン層は完全に実装されており、優れた設計になっています：

**実装済みコンポーネント:**
- **Value Objects**: `CardColor`, `CardValue`, `Position`
- **Entities**: `Card`, `Hand`, `Board`, `Deck`, `Player`
- **Services**: `Combo`, `ComboDetector`
- **Game Controller**: `Game`（ゲーム状態管理、ターン処理、役の処理）
- **テストコード**: 全ドメインロジックに対する包括的なユニットテスト

#### 1人対局モード実現のための推奨手順

ドメイン層が完成したので、次は**アプリケーション層**と**プレゼンテーション層**を実装します。

##### フェーズ1: アプリケーション層（状態管理）
**目的**: Reactコンポーネントとドメイン層をつなぐ

1. **ゲーム状態管理Hookの作成** (`src/hooks/useGameState.ts`)
   - `Game`クラスのインスタンスを保持
   - ゲーム状態の更新と再レンダリングを管理
   - カード配置、役の申告、ターン終了などのアクションを提供

2. **UI状態管理の作成** (`src/hooks/useUIState.ts`)
   - 選択中のカード、ハイライト表示など
   - 役申告モードの状態
   - エラーメッセージやアニメーションの状態

##### フェーズ2: プレゼンテーション層（コンポーネント）
**目的**: ゲームをブラウザで遊べるようにする

推奨コンポーネント構成:
```
src/components/
├── Game/
│   ├── GameContainer.tsx      # ゲーム全体のコンテナ
│   └── GameStatus.tsx         # ターン情報、星の数など
├── Board/
│   ├── BoardGrid.tsx          # 3x3の盤面
│   └── Cell.tsx               # 各マス（カード配置場所）
├── Card/
│   ├── CardComponent.tsx      # カードの表示
│   └── CardSymbol.tsx         # カードの数字とシンボル
├── Hand/
│   └── HandArea.tsx           # 手札エリア
└── ComboPanel/
    └── ComboClaimPanel.tsx    # 役申告パネル
```

**実装の優先順位:**
1. **基本UI**（フェーズ2a）
   - CardComponent: カードの視覚的表示（既存の画像素材を使用）
   - BoardGrid & Cell: 盤面の表示とクリック可能なマス
   - HandArea: 手札の表示
   - GameStatus: 現在のターン、星の数、山札残り枚数

2. **基本操作**（フェーズ2b）
   - 手札からカードを選択
   - 盤面の空きマスにカードを配置
   - ターン終了ボタン

3. **役申告機能**（フェーズ2c）
   - ComboDetectorを使った役の検出（ヒント表示用）
   - 役申告パネル
   - 役が成立した時の処理（カード除去、ドロー、星獲得）

4. **特殊ケース処理**（フェーズ2d）
   - 盤面満杯時のカード廃棄処理
   - 手札0枚時の山札からの直接配置
   - ゲーム終了と勝敗表示

##### フェーズ3: ポリッシュとUX改善
- アニメーション（カード配置、除去、星獲得）
- エラーメッセージの表示
- 操作のガイド・チュートリアル

#### 技術的な推奨事項

**状態管理:**
- React Hooksのみ（`useState`, `useReducer`）で十分
- 複雑な状態遷移がある場合は`useReducer`を検討
- グローバル状態管理ライブラリ（Redux等）は不要

**スタイリング:**
- CSS ModulesまたはPlain CSS
- ライトモードのトーンに合わせたデザイン
- レスポンシブ対応（モバイルでも遊べるように）

**ドメイン層との連携:**
- Gameクラスは不変ではないため、状態更新時に再レンダリングをトリガー
- `useState`で`Game`インスタンスを保持し、更新時に`setState`を呼ぶ
- または、各アクション後に強制再レンダリング（`useState`のカウンターなど）

#### 次のステップ（実装開始時）

まず以下から開始することを推奨:
1. `src/hooks/useGameState.ts`の作成
2. `src/components/Card/CardComponent.tsx`の作成
3. `src/components/Board/BoardGrid.tsx`と`Cell.tsx`の作成
4. `src/components/Game/GameContainer.tsx`でこれらを統合
5. `App.tsx`を更新してGameContainerを表示

この順序で進めることで、段階的に動作確認しながら開発できます。

## [x] カードのシンボルになる画像素材をつくってほしい
- 赤1, 赤4, 赤9, 赤16
- 青1, 青4, 青9, 青16
- ライトモードのトーンのゲームにしたいのでそこで生えるようにしてほしい

## [x] まずドメイン層のクラスの設計を実装をお願いしたい
- コントローラー層、プレゼンテーション層は、スケルトンでよい
- ドメインの責務になるロジックの実装、そのUTコードまで実装してほしい
- クラス図（クラス名だけでOK）を示せるとなおよい（任意）

## [x] READM.md を仕様書に基づいて更新してほしい
- 日本語でしあげてほしい
- MITライセンスのプロジェクトにしてほしい（別ファイルになってもよい）
- 著作権について保護対象であることを示してほしい